#!/usr/bin/env python

from __future__ import print_function, division
import numpy as np

import desitarget
import desitarget.targets
import desitarget.io as dtio
import desitarget.mock as dtmock
from desitarget import desi_mask
import argparse 


parser = argparse.ArgumentParser(description="Create mock target file from dark matter only mocks")
parser.add_argument("--output_dir", "-O", help="Path to write the outputs (targets,truth)", type=str, default="./")
parser.add_argument("--mock_qso", "-Q", help="Mock lightcone QSO file", type=str, required=True)
parser.add_argument("--mock_elg","-E", help="Mock lightcone ELG file", type=str, required=True)
parser.add_argument("--mock_lrg","-L", help="Mock lightcone LRG file", type=str, required=True)
parser.add_argument("--mock_random","-R", help="Mock lightcone random file", type=str, required=True)
parser.add_argument("--verbose", "-v", action='store_true')
args = parser.parse_args()

qso_mock_ra, qso_mock_dec, qso_mock_z = dtio.read_mock_dark_time(args.mock_qso)
elg_mock_ra, elg_mock_dec, elg_mock_z = dtio.read_mock_dark_time(args.mock_elg)
lrg_mock_ra, lrg_mock_dec, lrg_mock_z = dtio.read_mock_dark_time(args.mock_lrg)
random_mock_ra, random_mock_dec, random_mock_z = dtio.read_mock_dark_time(args.mock_random, read_z=False)

qso_mock_dens = dtmock.estimate_density(qso_mock_ra, qso_mock_dec)
elg_mock_dens = dtmock.estimate_density(elg_mock_ra, elg_mock_dec)
lrg_mock_dens = dtmock.estimate_density(lrg_mock_ra, lrg_mock_dec)
random_mock_dens = dtmock.estimate_density(random_mock_ra, random_mock_dec)

goal_density_qsoI = 120.0 # objects / deg^2
goal_density_qsoII = 50.0 # objects / deg^2
goal_density_qso_fake = 90.0 # objects / deg^2

ra_list = [qso_mock_ra, qso_mock_ra, qso_mock_ra]
dec_list = [qso_mock_dec, qso_mock_dec, qso_mock_dec]
z_list = [qso_mock_z, qso_mock_z, qso_mock_z]
min_z_list  = [2.1, -1.0, -1.0]
max_z_list  = [1000.0, 2.1, 1000.0]
goal_list = [goal_density_qsoI, goal_density_qsoII, goal_density_qso_fake]
true_type_list = ['QSO', 'QSO', 'STAR']
desi_tf_list = [desi_mask.QSO, desi_mask.QSO, desi_mask.QSO]
bgs_tf_list = [0,0,0]
mws_tf_list = [0,0,0]

for ra, dec, z, min_z, max_z, goal, true_type, desi_tf, bgs_tf, mws_tf in\
        zip(ra_list, dec_list, z_list, min_z_list, max_z_list, goal_list,\
                true_type_list, desi_tf_list, bgs_tf_list, mws_tf_list):

    ra_, dec_, z_ ,desi_flag_, bgs_flag_, mws_flag_, true_type_, sub_prior_ = \
        dtmock.select_population(ra, dec, z, min_z=min_z, max_z=max_z, goal_density=goal,\
        true_type=true_type, desi_target_flag = desi_tf, bgs_target_flag = bgs_tf, mws_target_flag = mws_tf)



print("LRG dens {}".format(lrg_mock_dens))
print("QSO dens {}".format(qso_mock_dens))
print("ELG dens {}".format(elg_mock_dens))
print("RAND dens {}".format(random_mock_dens))
